<!DOCTYPE html>
<html lang="en">
<!-- <head>  -->

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IBEOO Studio
    Controller</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.1/css/fontawesome.min.css">

  <script>
    function myFunction(name, job) {
      document.getElementById("status").innerHTML = "Welcome " + name + ", the " +
        job + ".";
    }

    // Error handler
    function detectErrors(response) {
      //Read the incoming response and check it for error. If it fails, handle it
      // If successful (i.e no errors detected), just return the response to the
      // next method in the chain
      if (!response.ok) {
        // HTML response contained errors,
        // document.getElementById(destFieldID).innerHTML = "Error. See javascript console"
        // And throw an Exception
        throw Error(response.statusText);
      }
      return response;

    }

    function logError(error, destFieldID) {
      // Log the error to the console
      console.log(error)
      // Update the destFieldID that threw the error
      document.getElementById(destFieldID).innerHTML = "Error. See javascript console"
    }

    // Get current time as HH:MM
    function currentTime() {
      return new Date().toLocaleTimeString([], {
        hour: '2-digit',
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      })

    }
    // Sends a command to a device via SSH
    // If destFieldID is set to 'undefined', the output will be ignored
    // function sendCmd(targetAddr, username, commandString, destFieldID) {
    //   // Construct the (relative) URL query where the data will be fetched from
    //   let url = 'api/sshcmd?deviceAddress=' + targetAddr + "&username=" + username + "&commandString=" + commandString
    //
    //   // Update status bar
    //   document.getElementById("cmd_sent").innerHTML = "(" + currentTime() + ")" + commandString + "==>" + username + "@" + targetAddr
    //   // Clear status bar response field
    //   document.getElementById("cmd_success").innerHTML = "Waiting.."
    //   // Fetch the response. Catch any errors and log to the javascript console
    //   fetch(url).then(detectErrors).then(response => response.text())
    //     .then(function(data) {
    //       // Update the target destFieldID (only if specified, otherwise write to the javascript console)
    //       if (destFieldID == undefined){
    //           console.log("Request: " + url + ", Response: " + data)
    //       }
    //       else {
    //         document.getElementById(destFieldID).innerHTML = data;
    //       }
    //       // Update the status bar
    //       document.getElementById("cmd_success").innerHTML = "(" + currentTime() + ") OK";
    //     }).catch(error => console.log(error));
    //
    // }
    // Sends a command to the Mikrotik router via SSH
    // If destFieldID is set to 'undefined', the output will be ignored
    function sendCmdToMikrotik(commandString, destFieldID) {
      // Construct the (relative) URL query where the data will be fetched from
      let url = 'api/sshcmd?commandString=' + commandString

      // Update status bar
      document.getElementById("cmd_sent").innerHTML = "(" + currentTime() + ")" + commandString
      // Clear status bar response field
      document.getElementById("cmd_success").innerHTML = "Waiting.."
      // Fetch the response. Catch any errors and log to the javascript console
      fetch(url).then(detectErrors).then(response => response.text())
        .then(function(data) {
          // Update the target destFieldID (only if specified, otherwise write to the javascript console)
          if (destFieldID == undefined) {
            console.log("Request: " + url + ", Response: " + data)
          } else {
            document.getElementById(destFieldID).innerHTML = data;
          }
          // Update the status bar
          document.getElementById("cmd_success").innerHTML = "(" + currentTime() + ") OK";
        }).catch(error => console.log(error));

    }

    // Executes a named script on the Mikrotik router
    function runMikrotikScript(scriptName) {
      // Construct the (relative) URL query where the data will be fetched from
      let url = 'api/mikrotik/scripts/run?scriptName=' + scriptName
      // Update status bar
      document.getElementById("cmd_sent").innerHTML = "(" + currentTime() + ")" + scriptName
      // Clear status bar response field
      document.getElementById("cmd_success").innerHTML = "Waiting.."
      // Fetch the response. Catch any errors and log to the javascript console
      // fetch(url).then(detectErrors).then(response => response.text())
      //   .then(function(data) {
      //     // Update the target destFieldID (only if specified, otherwise write to the javascript console)
      //     if (destFieldID == undefined){
      //         console.log("Request: " + url + ", Response: " + data)
      //     }
      //     else {
      //       document.getElementById(destFieldID).innerHTML = data;
      //     }
      //     // Update the status bar
      //     document.getElementById("cmd_success").innerHTML = "(" + currentTime() + ") OK";
      //   }).catch(error => console.log(error));
      fetch(url).then(detectErrors).then(response => response.text())
        .then(function(data) {
          // Update the target destFieldID (only if specified, otherwise write to the javascript console)
          if (destFieldID == undefined) {
            console.log("Request: " + url + ", Response: " + data)
          } else {
            document.getElementById(destFieldID).innerHTML = data;
          }
          // Update the status bar
          document.getElementById("cmd_success").innerHTML = "(" + currentTime() + ") OK";
        }).catch(function(error) {
          document.getElementById("cmd_success").innerHTML = "(" + currentTime() + ") FAIL";
          console.log(error); // Update the status bar
        });

    }

    // Retrieves the value of a Mikrotik value and updates the destFieldID on the page
    function fetchMikrotikGlobalVariable(varName, destFieldID) {
      // Construct the (relative) URL query where the data will be fetched from
      let url = 'api/mikrotik/variables/get?varName=' + varName
      // Fetch the response. Catch any errors and log to the javascript console
      fetch(url).then(detectErrors).then(response => response.text())
        .then(function(data) {
          // Update the target destFieldID (only if specified, otherwise write to the javascript console)
          if (destFieldID == undefined) {
            console.log("Request: " + url + ", Response: " + data)
          } else {
            // Update the field on the page, with fetched value
            document.getElementById(destFieldID).innerHTML = JSON.parse(data)[varName];
          }
          // Update the status bar
          document.getElementById("cmd_success").innerHTML = "(" + currentTime() + ") OK";
        }).catch(function(error) {
          document.getElementById("cmd_success").innerHTML = "(" + currentTime() + ") FAIL";
          console.log(error); // Update the status bar
        });

    }
    // Create timed auto-polling of the ssh commands that will populate the statusFields
    // defined in statusFields
    function registerPollers() {
      // Note: This method will be auto rendered when the page is created
      // and the tag below will be detected by the renderer
      // **DO NOT REMOVE THE NEXT LINE**
      // ##INSERT_POLLERS

    }
    // Automatically call registerPollers() when the page has loaded
    window.onload = registerPollers
  </script>

</head>

<body>
  <!-- Including Bootstrap JS (with its jQuery dependency) so that
    dynamic components work -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <h1>IBEOO Studio Controller V1.0</h1>
  Requested at: <currentTime></currentTime>

  <br>
  <statusFields></statusFields>
  <br>
  <!-- <button onclick="sendCmdToMikrotik(':put%20%22$[/system%20clock%20get%20time]%22')">Send Mikrotik Command</button> -->
  <routerSelectors></routerSelectors>

  <!-- Define a status bar for the latest commands and statuses -->
  <br>
  <br>
  <table border="1" style='font-size:80%'>
    <tr>
      <td>Status</td>
      <td id="cmd_sent">&nbsp;</td>
      <td id="cmd_success">&nbsp;</td>
    </tr>
  </table>

</body>

</html>
